#!/usr/bin/env python

# DIRT.
#
# Andy Mastbaum (amastbaum@gmail.com), August 2011

import sys

def get_available_tasks(db):
    tasks = []
    for id in db:
        try:
            if db[id]['type'] == 'record':
                record = db[id]
                for task in record['tasks']:
                    d = {}
                    d['record_id'] = id
                    d['task_name'] = task['name']
                    d['task_doc'] = task
                    tasks.append(d)
        except KeyError:
            pass
    return tasks

def serve_forever():
    import core.helpers
    import core.load_balance
    print 'dirt is running...'
    # do things forever

    # get outstanding tasks and available nodes
    db = core.helpers.connect_to_db()
    tasks = get_available_tasks(db)
    nodes = core.load_balance.round_robin(db)


def help():
    print \
'''Usage:

  dirt serve
  - Run the dirt remote execution server, which will dole out unfinished tasks
    in the database to available execution hosts.

  dirt updatenodes [host1] [host2] ...
  - Update stored system information on each host, adding the host to the
    database if necessary.
'''

if __name__ == '__main__':
    if len(sys.argv) < 2:
        help()
        sys.exit(1)

    if sys.argv[1] == 'serve':
        serve_forever()
    elif sys.argv[1] == 'updatenodes':
        import core.helpers
        nodes = sys.argv[2:]
        if len(nodes) == 0:
            help()
            sys.exit(1)
        core.helpers.node_recon(nodes, core.helpers.connect_to_db())

